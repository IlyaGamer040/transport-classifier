<!doctype html>
<meta charset="utf-8" />
<title>Transport Classifier - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</title>

<!-- TFJS + TeachableMachine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

<head>
  <link rel="stylesheet" href="./styles.css">
</head>

<header class="header">
  <div class="container">
    <div class="header-content">
      <img src="./logo.png" alt="Transport Classifier" class="logo">
      <div class="title-section">
        <h1>Transport Classifier</h1>
        <div class="subtitle">–°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è</div>
      </div>
    </div>
  </div>
</header>

<div class="main-content">
  <div class="container">
    <div class="grid">

      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í–≤–æ–¥ -->
       <div class="card fade-in">
        <div class="card-icon">üì∑</div>
        <h1 class="card-title">–í–≤–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h1>
       </div>

       <div class="btn-group">
        <button id="btn" class="btn btn-primary">
          <span>üé•</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É
        </button>
        <label class="btn btn-secondary" for="file">
          <span>üìÅ</span> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </label>
        <input id="file" type="file" accept="image/*" style="display:none">
       </div>

       <div class="preview-area" id="previewArea">
        <div class="preview-placeholder">
          <span>üñºÔ∏è</span>
          <div>–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>
        </div>
       </div>

       <div class="threshold-section">
        <div class="threshold-header">
          <span class="threshold-label">–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</span>
          <span class="threshold-value" id="thVal">65%</span>
        </div>
        <input id="th" type="range" min="30" max="95" value="65" class="threshold-slider">
        <div class="threshold-hint">
          –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ —É–≤–µ—Ä–µ–Ω–∞ –≤ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞), —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ <strong>¬´–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω¬ª</strong>
        </div>
       </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
     <div class="card fade-in">
      <div class="card-header">
        <div class="card-icon">üìä</div>
        <h2 class="card-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>
      </div>

      <div class="status" id="status">
        ‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è...
      </div>

      <div class="verdict" id="verdict" style="display:none">
        <div class="verdict-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:</div>
        <div class="verdict-result" id="verdictResult"></div>
        <div class="verdict-reason" id="verdictReason"></div>
      </div>

      <div id="probs"></div>
     </div>
  </div>
</div>

<script>
  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  let THRESHOLD = 0.65;
  const MARGIN_MIN = 0.10;
  const ENTROPY_MAX = 1.2;

  // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  const btn = document.getElementById('btn');
  const file = document.getElementById('file');
  const previewArea = document.getElementById('previewArea');
  const statusEl = document.getElementById('status');
  const verdictEl = document.getElementById('verdict');
  const verdictResult = document.getElementById('verdictResult');
  const verdictReason = document.getElementById('verdictReason');
  const probsEl = document.getElementById('probs');
  const thSlider = document.getElementById('th');
  const thValue = document.getElementById('thVal');

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞
  thSlider.addEventListener('input', e => {
    THRESHOLD = Number(e.target.value) / 100;
    thValue.textContent = `${e.target.value}%`;
  });

  // –ú–æ–¥–µ–ª—å –∏ –∫–∞–º–µ—Ä–∞
  let model, webcam, raf;

  // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
  (async () => {
    try {
      statusEl.innerHTML = 'üîÑ –ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...';
      model = await tmImage.load(`model.json`, `metadata.json`);
      statusEl.innerHTML = '‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–º–µ—Ä—É';
    } catch (e) {
      statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏';
      console.error('LOAD ERROR:', e);
    }
  })();

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
  function renderBars(preds) {
    probsEl.innerHTML = '';
    preds.forEach(p => {
      const item = document.createElement('div');
      item.className = 'probability-item';
      
      const label = document.createElement('div');
      label.className = 'probability-label';
      label.textContent = p.className;
      
      const bar = document.createElement('div');
      bar.className = 'probability-bar';
      
      const fill = document.createElement('div');
      fill.className = 'probability-fill';
      fill.style.width = `${(p.probability * 100).toFixed(1)}%`;
      bar.appendChild(fill);
      
      const value = document.createElement('div');
      value.className = 'probability-value';
      value.textContent = `${(p.probability * 100).toFixed(1)}%`;
      
      item.append(label, bar, value);
      probsEl.appendChild(item);
    });
  }

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  function renderVerdict(preds) {
    const sorted = [...preds].sort((a, b) => b.probability - a.probability);
    const top1 = sorted[0];
    const top2 = sorted[1] || { probability: 0 };

    const belowThreshold = top1.probability < THRESHOLD;
    const margin = top1.probability - top2.probability;
    const smallMargin = margin < MARGIN_MIN;

    let H = 0;
    for (const p of preds) {
      if (p.probability > 0) H += -p.probability * Math.log(p.probability);
    }
    const highEntropy = H > ENTROPY_MAX;

    verdictEl.style.display = 'block';

    if (belowThreshold || smallMargin || highEntropy) {
      const reasons = [];
      if (belowThreshold) reasons.push(`–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∏–∂–µ ${Math.round(THRESHOLD * 100)}%`);
      if (smallMargin) reasons.push(`–º–∞–ª—ã–π —Ä–∞–∑—Ä—ã–≤ —Å –¥—Ä—É–≥–∏–º –∫–ª–∞—Å—Å–æ–º`);
      if (highEntropy) reasons.push(`–Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏`);

      verdictResult.textContent = '–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω';
      verdictResult.style.color = 'var(--warning)';
      verdictReason.textContent = `–ü—Ä–∏—á–∏–Ω—ã: ${reasons.join(', ')}`;
      verdictEl.style.background = 'linear-gradient(135deg, #fef5e7, #fed7aa)';
      verdictEl.style.borderLeftColor = 'var(--warning)';
    } else {
      verdictResult.textContent = `${top1.className} (${(top1.probability * 100).toFixed(1)}%)`;
      verdictResult.style.color = 'var(--success)';
      verdictReason.textContent = `–í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —Ä–∞–∑—Ä—ã–≤ —Å —Å–ª–µ–¥—É—é—â–∏–º –∫–ª–∞—Å—Å–æ–º: ${(margin * 100).toFixed(1)}%`;
      verdictEl.style.background = 'linear-gradient(135deg, #f0fff4, #c6f6d5)';
      verdictEl.style.borderLeftColor = 'var(--success)';
    }
  }

  // –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
  async function predictOn(el) {
    if (!model) return;
    try {
      const preds = await model.predict(el);
      statusEl.style.display = 'none';
      renderVerdict(preds);
      renderBars(preds);
    } catch (e) {
      statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
      statusEl.style.display = 'block';
      console.error('PREDICT ERROR:', e);
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
  file.onchange = e => {
    const f = e.target.files?.[0];
    if (!f) return;

    if (raf) cancelAnimationFrame(raf);
    if (webcam) webcam.stop();

    const url = URL.createObjectURL(f);
    previewArea.innerHTML = `<img src="${url}" alt="Preview" style="width:100%;height:100%;object-fit:cover;">`;

    const img = previewArea.querySelector('img');
    img.onload = async () => {
      await predictOn(img);
      URL.revokeObjectURL(url);
    };
  };

  // –†–∞–±–æ—Ç–∞ —Å –∫–∞–º–µ—Ä–æ–π
  btn.onclick = async () => {
    if (!model) return;
    try {
      if (raf) cancelAnimationFrame(raf);
      if (webcam) webcam.stop();

      statusEl.innerHTML = 'üé• –ó–∞–ø—É—Å–∫–∞—é –∫–∞–º–µ—Ä—É...';
      statusEl.style.display = 'block';

      webcam = new tmImage.Webcam(400, 400, true);
      await webcam.setup();
      await webcam.play();

      previewArea.innerHTML = '';
      previewArea.appendChild(webcam.canvas);

      statusEl.style.display = 'none';
      loop();
    } catch (e) {
      statusEl.innerHTML = '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
      console.error(e);
    }
  };

  // –¶–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
  async function loop() {
    webcam.update();
    await predictOn(webcam.canvas);
    raf = requestAnimationFrame(loop);
  }

  // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  window.addEventListener('beforeunload', () => {
    if (raf) cancelAnimationFrame(raf);
    if (webcam) webcam.stop();
  });
</script>